os:
  - linux
#  - osx
language: java
dist: xenial
jdk:
  - openjdk8

cache:
  directories:
    - $HOME/.cache
    - $HOME/.m2
    - $TRAVIS_BUILD_DIR/core/target
    - $TRAVIS_BUILD_DIR/launcher/target

install: true

jobs:
  include:
    # Do the actual build (and test reporting)
    - stage: package (maven)
      script: mvn -B clean package -Pdistribute --settings ./ci/.travis-settings.xml

    - stage: report tests (sonarqube)
      if: branch =~ ^release\/.*$
      script: mvn -B -DskipTests=true -f core org.jacoco:jacoco-maven-plugin:prepare-agent sonar:sonar

    # Distribute binairies
    - stage: distribute
      if: branch =~ ^release\/.*$
      script: mvn -B -DskipTests=true deploy --settings ./ci/.travis-settings.xml

    - stage: distribute
      if: branch =~ ^release\/.*$
      services:
        - docker
      script: (cd ./launcher/target/docker/ && bash build.sh)

    - stage: distribute
      script: true
      deploy:
        provider: releases
        skip_cleanup: true
        token: $GITHUB_OAUTH
        draft: true
        file_glob: true
        file: launcher/target/dist/*
        on:
          tags: true
